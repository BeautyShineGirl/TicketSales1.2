package cn.nvinfo.controller;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.swing.JOptionPane;


import org.apache.log4j.Logger;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.multipart.MultipartFile;


import cn.nvinfo.domain.User;
import cn.nvinfo.domain.ViewMessage;
import cn.nvinfo.service.ViewService;
import cn.nvinfo.tools.ViewDictionary;
import cn.nvinfo.tools.ViewExcel;
import cn.nvinfo.tools.ViewList;
import cn.nvinfo.utils.CheckUtil;
import cn.nvinfo.utils.ExportExcel;
import cn.nvinfo.utils.Pager;
import cn.nvinfo.utils.Result;

/**
 *  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½    
 * @author ï¿½ï¿½ï¿½ï¿½   2017-09-19
 *
 */

@Controller
@Scope("prototype")
@SessionAttributes("staff")
@RequestMapping("view")
public class ViewAction {
	Logger log=Logger.getLogger(ViewAction.class);
	@Resource
	private ViewService viewService;
	private Integer pageSize=10;
    
	/**
	 *  ï¿½ï¿½Ò³ï¿½ï¿½Ñ¯	ï¿½ï¿½ï¿½ï¿½  2017-09-21 
	 * @param pageIndex
	 * @param pageSize
	 * @return
	 */
	@RequestMapping("/findPageData.action")
	public @ResponseBody Object findPageData(Integer pageIndex,Integer viewId,Integer logic,String staffName,
			String viewName,String level,String viewType,String province,String city,Integer staff_id,Integer power_id){
		//ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ï¿½
		if(!"".equals(CheckUtil.checkArgsNotNull(pageIndex,staff_id,power_id))){
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½");
		}
		log.info("ï¿½ï¿½Ò³ï¿½ï¿½Ñ¯ï¿½á½»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"+","+pageIndex+","+viewId+","+logic+","+staffName+","+viewName+","+level+","+viewType+","+province+","+city);
		Pager<ViewMessage> pager=null;
		if(power_id==0){
			log.info("ÏµÍ³ï¿½ï¿½ï¿½ï¿½Ô±");
			//ÏµÍ³ï¿½ï¿½ï¿½ï¿½Ô±
			pager=viewService.getPager(pageIndex,pageSize,viewId,logic,staffName,viewName,level,viewType,province,city);
		}else{
			log.info("ï¿½ï¿½Í¨ï¿½ï¿½ï¿½ï¿½Ô±");
			//ï¿½ï¿½Í¨ï¿½ï¿½ï¿½ï¿½Ô±	yangli	2017-10-19
			pager=viewService.getPager(pageIndex,pageSize,viewId,logic,staffName,viewName,level,viewType,province,city,staff_id);
		}
		List<ViewList> list = new ArrayList<ViewList>();  
		if(pager.getDatas().size()!=0){
			for (ViewMessage v : pager.getDatas()) {
				int id = v.getId();
				//ï¿½ï¿½Ñ¯Ã¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ó¦ï¿½Ä²ï¿½Æ·ï¿½ï¿½ï¿½ï¿½
				int num=viewService.getViewNum(id);
				ViewList view =new ViewList();
				view.setId(v.getId());
				view.setName(v.getName());
				view.setLevel(v.getLevel());
				view.setSort(v.getSort());
				view.setStaffId(v.getStaffId());
				view.setBusinessTime(v.getBusinessTime());
				view.setViewType(v.getType());
				view.setNumber(num);
				view.setStaffName(v.getStaffName());
				list.add(view);
			}
			Map<Object,Object> listPage=new HashMap<Object,Object>();
			listPage.put("allCount",pager.getAllCount());
			listPage.put("currPage",pager.getCurrPage());
			listPage.put("pageSize",pager.getPageSize());
			listPage.put("pageCount",pager.getPageCount());
			listPage.put("datas",list);
			log.info(new Result(1,"ï¿½ï¿½Ñ¯ï¿½É¹ï¿½",listPage));
			return new Result(1,"ï¿½ï¿½Ñ¯ï¿½É¹ï¿½",listPage);
		}else{
<<<<<<< .mine
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½",listPage));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½",listPage);
=======
			log.info(new Result(0,"ÔÝÎÞÊý¾Ý"));
			return new Result(0,"ÔÝÎÞÊý¾Ý");
>>>>>>> .r188
		}

	}
	
	/**
	 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ó£¬·ï¿½ï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½	ï¿½ï¿½ï¿½ï¿½   2017-09-19 
	 * @return
	 */
	@RequestMapping("/addUI.action")
	public @ResponseBody Object addUI(){
		//ï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½Ð»ï¿½Ã¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		List<String> typeList=viewService.getViewType();
		//ï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½Ð»ï¿½Ä¾ï¿½ï¿½ï¿½È¼ï¿½
		List<String> levelList=viewService.getViewLevel();
		//ï¿½ï¿½ï¿½Öµï¿½ï¿½Ð»ï¿½ï¿½Ê¡ï¿½Ý¼ï¿½ï¿½ï¿½
		List<String> viewProvince=viewService.getViewProvince();
		//ï¿½ï¿½ï¿½Öµï¿½ï¿½Ð»ï¿½Ã³ï¿½ï¿½Ð¼ï¿½ï¿½ï¿½
		List<String> viewCity=viewService.getViewCity();
		//ï¿½ï¿½ï¿½Òµï¿½ï¿½Ô±ï¿½Ä±ï¿½Åºï¿½ï¿½ï¿½ï¿½ï¿½     ï¿½ï¿½ï¿½ï¿½     2017-09-20
		List<User> staff=viewService.getStaff();
		ViewDictionary vd=new ViewDictionary();
		vd.setViewType(typeList);
		vd.setViewLevel(levelList);
		vd.setViewProvince(viewProvince);
		vd.setViewCity(viewCity);
		vd.setStaff(staff);
		log.info(new Result(1,"ï¿½ï¿½Ñ¯ï¿½É¹ï¿½",vd));
		return new Result(1,"ï¿½ï¿½Ñ¯ï¿½É¹ï¿½",vd);
	}
	
	/**
	 * ï¿½ï¿½Ó¾ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢    ï¿½ï¿½ï¿½ï¿½   2017-09-20    ï¿½ï¿½ï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	 * @param view
	 * @param request
	 * @param file
	 * @return
	 */
	@RequestMapping(value="/add.action")
	public @ResponseBody Object add(ViewMessage view ,@RequestParam("file")MultipartFile[] file,HttpServletRequest request/*MultipartFile file,*/){
		String name= view.getName();
		String level=view.getLevel();
		String viewType=view.getType();
		String address=view.getAddress();
		String businessTime=view.getBusinessTime();
		String phone=view.getPhone();
		String reminder=view.getReminder(); 
		String discount=view.getDiscount();
		String busMessage=view.getBusMessage();
		String selfRoute=view.getSelfRoute();		
		Integer staffId = view.getStaffId();
		//ï¿½ï¿½ï¿½staffIdï¿½ï¿½ï¿½ï¿½ï¿½ï¿½	ï¿½ï¿½ï¿½ï¿½	2017-10-26
		view.setStaffName(viewService.getByStaffId(staffId));
		Double lng =view.getLng();
		Double lat=view.getLat();
		Integer sort=view.getSort();
		String province=view.getProvince();
		String city=view.getCity();
	/*	//ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ï¿½
		if(!"".equals(CheckUtil.checkArgsNotNull(name,level,viewType,address,businessTime,
				phone,discount,staffId,lng,lat,sort,province,city))){
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½");
		}
*/
		log.info("ï¿½ï¿½ï¿½ï¿½á½»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"+","+name+","+level+","+viewType+","+address+","+businessTime+","+phone+","+reminder+","+discount
				+","+busMessage+","+selfRoute+","+staffId+","+lng+","+lat+","+sort+","+province+","+city);
		String picture=null;
		//ï¿½Ï´ï¿½Í¼Æ¬
		if(file.length==0){
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ¬"));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ¬");
		}
		MultipartFile multipartFile = null;
		for (int i=0;i<file.length; i++) {
			multipartFile = file[i];
			String iconName=multipartFile.getOriginalFilename();
			//ï¿½ï¿½ï¿½ï¿½ï¿½Ä¼ï¿½  
			saveFile(multipartFile,request);  
			//ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿½Ä¼ï¿½ï¿½ï¿½Â·ï¿½ï¿½
			if(picture==null||picture.equals("")){
				picture=new SimpleDateFormat("yyyyMMddhhmmss").format(new Date())+iconName;
			}else{
				picture=picture+","+new SimpleDateFormat("yyyyMMddhhmmss").format(new Date())+iconName;
			}
        }
		
        //ï¿½ï¿½ï¿½ï¿½Í¼Æ¬ï¿½ï¿½ï¿½ï¿½
        view.setPicture(picture);
        //ï¿½ï¿½Ó²ï¿½ï¿½ï¿½
        
        int rows= viewService.add(view);
        if(rows>0){
        	log.info(new Result(1,"ï¿½ï¿½Ó³É¹ï¿½"));
        	return new Result(1,"ï¿½ï¿½Ó³É¹ï¿½");
        } else {
        	log.info(new Result(0,"ï¿½ï¿½ï¿½Ê§ï¿½ï¿½"));
        	return new Result(0,"ï¿½ï¿½ï¿½Ê§ï¿½ï¿½");
        } 
	}
	/*** 
	 * ï¿½ï¿½ï¿½ï¿½ï¿½Ä¼ï¿½ 
	 * @param file 
	 * @return 
	 */  
	public boolean saveFile(MultipartFile file,HttpServletRequest request) {  
		String iconName=file.getOriginalFilename();
		// Ð£ï¿½ï¿½Í¼Æ¬ï¿½ï¿½Ê½  
		// ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½Ï´ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½Â·ï¿½ï¿½ï¿½ï¿½ï¿½Ö£ï¿½Ö»ï¿½ï¿½ï¿½ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½  
		String lastName = iconName.substring(iconName.lastIndexOf("\\") + 1);  
		// ï¿½Ãµï¿½ï¿½Ï´ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½Õ¹ï¿½ï¿½  
		String fileExtName = lastName.substring(lastName.lastIndexOf(".") + 1);//doc,docx,pdf
		// Ð£ï¿½ï¿½Í¼Æ¬ï¿½ï¿½Ê½ 	ï¿½ï¿½Î´ï¿½ï¿½ï¿½Ã»ï¿½Ð²ï¿½ï¿½ï¿½
		if("bmp".equals(fileExtName)||"jpg".equals(fileExtName)||
				"jpeg".equals(fileExtName)||"gif".equals(fileExtName)||"png".equals(fileExtName)){
			//ï¿½ï¿½È¡ï¿½Ï´ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½Â·ï¿½ï¿½
			String src=request.getSession().getServletContext().getRealPath("upload/images/")+File.separator;
			String path=src+new SimpleDateFormat("yyyyMMddhhmmss").format(new Date())+iconName;
			File newFile=new File(path);
			try {
				file.transferTo(newFile);
			} catch (Exception e) {
				e.printStackTrace();
			} 
			
		}
		return false; 	
	}
	/**
	 * ï¿½Þ¸ï¿½ï¿½ï¿½Ý»ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½  2017-09-21 
	 * @param id
	 * @return
	 */
	@RequestMapping("/editUI.action")
	public @ResponseBody Object editUI(Integer id,HttpServletRequest request){
		 
		//ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ï¿½ 
		if(!"".equals(CheckUtil.checkArgsNotNull(id))){
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½");
		}
		
		
		//ï¿½ï¿½Ñ¯
		ViewMessage view = viewService.getById(id);
		String picture = view.getPicture();
		if(picture==null&&"".equals("")){
			view.setPic(null);
		}else{
			String[] split = picture.split(",");
			List<String> list=new ArrayList<String>();
			for (String string : split) {
				String path="http://test.elvmedia.cn:8080/Ticket"+request.getContextPath()+"/upload/images/"+string;
				list.add(path);
			}
			view.setPic(list);
			
		}
		log.info(new Result(1,"ï¿½ï¿½Ñ¯ï¿½É¹ï¿½",view));
		return new Result(1,"ï¿½ï¿½Ñ¯ï¿½É¹ï¿½",view);
	}
	
	/**
	 * ï¿½Þ¸ï¿½	ï¿½ï¿½ï¿½ï¿½	2017-09-21
	 * @param view
	 * @param file
	 * @param request
	 * @return
	 */
	@RequestMapping("/edit.action")
	public @ResponseBody Object edit(ViewMessage view,@RequestParam("file") MultipartFile[] file,HttpServletRequest request,Integer pageIndex){
		Integer id=view.getId();
		String name= view.getName();
		String level=view.getLevel();
		String viewType=view.getType();
		String remark=view.getRemark();
		String address=view.getAddress();
		String businessTime=view.getBusinessTime();
		String phone=view.getPhone();
		String reminder=view.getReminder();
		String discount=view.getDiscount();
		String busMessage=view.getBusMessage();
		String selfRoute=view.getSelfRoute();		
		Integer staffId = view.getStaffId();
		//ï¿½ï¿½ï¿½staffIdï¿½ï¿½ï¿½ï¿½ï¿½ï¿½	ï¿½ï¿½ï¿½ï¿½	2017-10-26
		view.setStaffName(viewService.getByStaffId(staffId));
		Double lng =view.getLng();
		Double lat=view.getLat();
		Integer sort=view.getSort();
		String province=view.getProvince();
		String city=view.getCity();
		@SuppressWarnings("unused")
		boolean isLegal = false; 
		/*//ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ï¿½
		if(!"".equals(CheckUtil.checkArgsNotNull(id,name,level,viewType,remark,address,businessTime,
				phone,discount,staffId,lng,lat,sort,province,city))){
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½");
		}*/
		log.info("ï¿½Þ¸ï¿½ï¿½á½»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"+","+id+","+name+","+level+","+viewType+","+remark+","+address+","+businessTime+","+
				phone+","+reminder+","+discount+","+busMessage+","+selfRoute+","+staffId+","+lng+","+
				lat+","+sort+","+province+","+city);

		//É¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð±ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢ï¿½ï¿½ï¿½ï¿½Æ¬ï¿½ï¿½ï¿½È½ï¿½ï¿½Â´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¼Æ¬pictureï¿½ï¿½Ö®Ç°ï¿½ï¿½ï¿½ï¿½Ê²Ã´ï¿½ï¿½Í¬ï¿½ï¿½ï¿½ï¿½Ö®Ç°picï¿½ï¿½ï¿½ï¿½ï¿½Âµï¿½pictureï¿½ï¿½Ã»ï¿½Ðµï¿½ï¿½Ú·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
		//ï¿½ï¿½ï¿½ï¿½Õ·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÐµÄ¸Ã¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ¬ï¿½ï¿½pictureï¿½ï¿½Îªï¿½Õ£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		ViewMessage viewPic = viewService.getById(id);
		String[] arr = viewPic.getPicture().split(",");
		for (int i=0;i<arr.length; i++) {
			String src=request.getSession().getServletContext().getRealPath("upload/files/")+File.separator;
			String path=src+arr[i];
			// ï¿½Ð¶ï¿½Ä¿Â¼ï¿½ï¿½ï¿½Ä¼ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿½  
			File file1 = new File(path); 
			// Â·ï¿½ï¿½Îªï¿½Ä¼ï¿½ï¿½Ò²ï¿½Îªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½  
			if (file1.isFile() && file1.exists()) {  
				file1.delete();  
			} 
		}
		viewService.delPicture(id);
		String picture=null;
		//ï¿½Ï´ï¿½Í¼Æ¬
		if(file.length==0){
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ¬"));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ¬");
		}
		MultipartFile multipartFile = null;
		for (int i=0;i<file.length; i++) {
			multipartFile = file[i];
			//ï¿½ï¿½È¡ï¿½Ï´ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½Â·ï¿½ï¿½
			String iconName=multipartFile.getOriginalFilename();
			//ï¿½ï¿½ï¿½ï¿½ï¿½Ä¼ï¿½  
			saveFile(multipartFile,request);  
			//ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿½Ä¼ï¿½ï¿½ï¿½Â·ï¿½ï¿½
			if(picture==null||picture.equals("")){
				picture=new SimpleDateFormat("yyyyMMddhhmmss").format(new Date())+iconName;
			}else{
				picture=picture+","+new SimpleDateFormat("yyyyMMddhhmmss").format(new Date())+iconName;
			}
		}
		//ï¿½ï¿½ï¿½ï¿½Í¼Æ¬ï¿½ï¿½ï¿½ï¿½
		view.setPicture(picture);

		//ï¿½Þ¸Ä²ï¿½ï¿½ï¿½
		int rows= viewService.edit(view);
		if(rows>0){
			log.info(new Result(1,"ï¿½Þ¸Ä³É¹ï¿½"));
			return new Result(1,"ï¿½Þ¸Ä³É¹ï¿½");
		} else {
			log.info(new Result(0,"ï¿½Þ¸ï¿½Ê§ï¿½ï¿½"));
			return new Result(0,"ï¿½Þ¸ï¿½Ê§ï¿½ï¿½");
		}		
	}

	/**
	 * É¾ï¿½ï¿½  	ï¿½ï¿½ï¿½ï¿½   2017-09-20  
	 * @param id
	 * @return
	 */
	@RequestMapping("/delete.action")
	public @ResponseBody Object delete(Integer id){
		//ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ï¿½
		if(!"".equals(CheckUtil.checkArgsNotNull(id))){
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½");
		}
		log.info("É¾ï¿½ï¿½ï¿½á½»ï¿½ï¿½ï¿½ï¿½Ï¢ï¿½ï¿½"+","+id);
		//ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½Ö®Ç°ï¿½ï¿½ï¿½È²ï¿½Ñ¯ï¿½Ã¾ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½Ð²ï¿½Æ·ï¿½ï¿½ï¿½ï¿½ï¿½Ð£ï¿½ï¿½ò·µ»ï¿½É¾ï¿½ï¿½Ê§ï¿½ï¿½
		int viewCount=viewService.getProduct(id);
		if(viewCount!=0){
			log.info(new Result(0,"É¾ï¿½ï¿½Ê§ï¿½Ü£ï¿½ï¿½Ã¾ï¿½ï¿½ï¿½ï¿½ï¿½Ú²ï¿½Æ·"));
			return new Result(0,"É¾ï¿½ï¿½Ê§ï¿½Ü£ï¿½ï¿½Ã¾ï¿½ï¿½ï¿½ï¿½ï¿½Ú²ï¿½Æ·");
		}
		//ï¿½Þ¸Ä²ï¿½ï¿½ï¿½
		int rows= viewService.delete(id);
		if(rows>0){
			log.info(new Result(1,"É¾ï¿½ï¿½É¹ï¿½"));
			return new Result(1,"É¾ï¿½ï¿½É¹ï¿½");
		} else {
			log.info(new Result(0,"É¾ï¿½ï¿½Ê§ï¿½ï¿½"));
			return new Result(0,"É¾ï¿½ï¿½Ê§ï¿½ï¿½");
		}		
	}

	/**
	 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢ï¿½ï¿½ï¿½	ï¿½ï¿½ï¿½ï¿½	2017-09-21   Î´ï¿½Åµï¿½ï¿½ï¿½Ä¿ï¿½Ð²ï¿½    ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½á¸²ï¿½ï¿½Ö®Ç°ï¿½ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½Ì·ï¿½Í¸ï¿½ï¿½ï¿½
	 * @param pageIndex
	 * @return
	 */
	@RequestMapping("/outExcel.action")
	public @ResponseBody Object outExcel(Integer pageIndex,Integer viewId,Integer logic,String staffName,
			String viewName,String level,String viewType,String province,String city)  
	{  
		if(!"".equals(CheckUtil.checkArgsNotNull(pageIndex))){
			log.info(new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"));
			return new Result(0,"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½");
		}
		log.info("ï¿½ï¿½ï¿½ï¿½ï¿½á½»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"+","+pageIndex+","+viewId+","+logic+","+staffName+","+viewName+","+level+","+viewType+","+province+","+city);
		Pager<ViewMessage> pager=viewService.getPager(pageIndex,pageSize,viewId,logic,staffName,viewName,level,viewType,province,city); 
		ExportExcel<ViewExcel> ex = new ExportExcel<ViewExcel>();  
		String[] headers =  
			{ "ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½", "ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½", "ï¿½ï¿½ï¿½ï¿½È¼ï¿½", "ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½" ,"ï¿½ï¿½ï¿½ï¿½ï¿½Æ·ï¿½ï¿½ï¿½ï¿½", "ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½", "ÓªÒµÊ±ï¿½ï¿½","ï¿½ï¿½ï¿½ï¿½Òµï¿½ï¿½ï¿½ï¿½Ô±"};  

		List<ViewExcel> dataset = new ArrayList<ViewExcel>();  
		for (ViewMessage v : pager.getDatas()) {
			int id = v.getId();
			//ï¿½ï¿½Ñ¯Ã¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ó¦ï¿½Ä²ï¿½Æ·ï¿½ï¿½ï¿½ï¿½
			int num=viewService.getViewNum(id);
			ViewExcel view =new ViewExcel();
			view.setId(v.getId());
			view.setName(v.getName());
			view.setLevel(v.getLevel());
			view.setViewType(v.getType());
			view.setSort(v.getSort());
			view.setNumber(num);
			view.setBusinessTime(v.getBusinessTime());
			view.setStaffName(v.getStaffName());
			dataset.add(view);
		}

		try{
			OutputStream out = new FileOutputStream("E://ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢ï¿½ï¿½ï¿½ï¿½ï¿½.xls");  
			ex.exportExcel(headers, dataset, out);  
			out.close();  			
			JOptionPane.showMessageDialog(null, "ï¿½ï¿½ï¿½ï¿½ï¿½É¹ï¿½!");  
		} catch (FileNotFoundException e) {  
			e.printStackTrace();  
		} catch (IOException e) {  
			e.printStackTrace();  
		} 
		log.info(new Result(1,"ï¿½ï¿½ï¿½ï¿½ï¿½É¹ï¿½"));
		return new Result(1,"ï¿½ï¿½ï¿½ï¿½ï¿½É¹ï¿½");
	}  	
}
